<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>خريطة شركات خدمات الدفع</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; }
    #controls {
      padding: 10px;
      background-color: white;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="companySelect">اختر اسم الشركة:</label>
    <select id="companySelect">
      <option value="">-- اختر شركة --</option>
    </select>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script>
    const map = L.map('map').setView([31.95, 35.93], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let allFeatures = [];
    let mainCenters = [];

    const companySelect = document.getElementById('companySelect');

    fetch('https://yourusername.github.io/servicespayment.json') // ← غيّر هذا الرابط لرابط GitHub الحقيقي
      .then(response => response.json())
      .then(data => {
        allFeatures = data.features;

        // أول 5 ميزات = مراكز رئيسية
        mainCenters = allFeatures.slice(0, 5);

        // تعبئة أسماء الشركات بدون تكرار
        const companyNames = [...new Set(allFeatures.map(f => f.properties.شركة))].sort();
        companyNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          companySelect.appendChild(option);
        });
      });

    function clearMapLayers() {
      map.eachLayer(layer => {
        if (layer instanceof L.Polyline || layer instanceof L.CircleMarker || layer instanceof L.GeoJSON) {
          if (!layer._url) map.removeLayer(layer);
        }
      });
    }

    function showBranchesForCompany(companyName) {
      clearMapLayers();

      const branches = allFeatures.filter(f => f.properties.شركة === companyName);
      const centers = mainCenters.filter(f => f.properties.شركة === companyName);

      // رسم المراكز الرئيسية
      const centerLayer = L.geoJSON(centers, {
        onEachFeature: (feature, layer) => {
          const name = feature.properties.اسم_ا || 'غير معروف';
          layer.bindPopup(`<b>مركز رئيسي:</b> ${name}<br><b>الشركة:</b> ${feature.properties.شركة}`).openPopup();
        },
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, {
            radius: 8,
            color: 'green',
            fillColor: 'yellow',
            fillOpacity: 0.9
          });
        }
      }).addTo(map);

      // رسم الفروع
      const branchLayer = L.geoJSON(branches, {
        onEachFeature: (feature, layer) => {
          const name = feature.properties.اسم_ا || 'غير معروف';
          const branchCoord = feature.geometry.coordinates;
          let nearestDistance = null;

          for (let center of centers) {
            const centerCoord = center.geometry.coordinates;
            if (branchCoord[0] === centerCoord[0] && branchCoord[1] === centerCoord[1]) continue;

            const from = turf.point(centerCoord);
            const to = turf.point(branchCoord);
            const distance = turf.distance(from, to, { units: 'kilometers' });

            if (nearestDistance === null || distance < nearestDistance) {
              nearestDistance = distance;
            }
          }

          const distanceText = nearestDistance !== null
            ? `<br><b>المسافة إلى أقرب مركز رئيسي:</b> ${nearestDistance.toFixed(2)} كم`
            : `<br><b>المسافة:</b> غير متوفرة`;

          layer.bindPopup(
            `<b>الفرع:</b> ${name}<br><b>الشركة:</b> ${feature.properties.شركة}${distanceText}`
          ).openPopup();
        },
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, {
            radius: 6,
            color: 'blue'
          });
        }
      }).addTo(map);

      const group = L.featureGroup([centerLayer, branchLayer]);
      map.fitBounds(group.getBounds());
    }

    companySelect.addEventListener('change', () => {
      const selected = companySelect.value;
      if (selected) {
        showBranchesForCompany(selected);
      }
    });
  </script>
</body>
</html>
